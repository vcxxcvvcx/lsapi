import asyncio
import pymysql
import requests
from datetime import datetime
from ebest import OpenApi
from app_keys import appkey, appsecretkey
from pykrx.stock import get_market_cap_by_ticker
from kiwoom_key import token  # í‚¤ì›€ ì¸ì¦ í† í° ë¶ˆëŸ¬ì˜¤ê¸°

# ì˜¤ëŠ˜ ë‚ ì§œ (yyyymmdd)
today = datetime.today().strftime("%Y%m%d")

# ğŸ” PyKRX ë§ˆì¼“ìº¡ ë°ì´í„° ë¡œë”©
try:
    df_market_cap = get_market_cap_by_ticker(today)
except Exception as e:
    print(f"âŒ pykrx ë§ˆì¼“ìº¡ ë¡œë”© ì‹¤íŒ¨: {e}")
    df_market_cap = None

# MySQL ì ‘ì† ì„¤ì •
MYSQL_CONFIG = {
    'host': 'localhost',
    'user': 'root',
    'password': '5737',
    'database': 'stock_data',
    'charset': 'utf8mb4'
}

# ì•ˆì „í•œ ì •ìˆ˜ ë³€í™˜
def safe_int(value):
    try:
        return int(str(value).replace(',', '').strip())
    except:
        return 0

# â›½ PyKRXì—ì„œ ìƒì¥ì£¼ì‹ìˆ˜ ë³´ì™„
def get_fallback_listed_shares(shcode):
    try:
        code = shcode.zfill(6)
        if df_market_cap is not None and code in df_market_cap.index:
            return int(df_market_cap.loc[code]['ìƒì¥ì£¼ì‹ìˆ˜'])
    except Exception as e:
        print(f"âš ï¸ pykrxì—ì„œ {shcode} ì¡°íšŒ ì‹¤íŒ¨: {e}")
    return 0

# âœ… í‚¤ì›€ APIë¥¼ í†µí•´ ì´ì”ëŸ‰ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
def get_total_qty_from_kiwoom(shcode):
    url = "https://api.kiwoom.com/api/dostk/mrkcond"
    headers = {
        "Content-Type": "application/json;charset=UTF-8",
        "authorization": f"Bearer {token}",
        "api-id": "ka10004"
    }
    payload = { "stk_cd": shcode.zfill(6) }  # ì¢…ëª©ì½”ë“œ

    try:
        res = requests.post(url, headers=headers, json=payload)
        if res.status_code == 200:
            js = res.json()
            return (
                safe_int(js.get("tot_sel_req", 0)),  # ì´ë§¤ë„ì”ëŸ‰
                safe_int(js.get("tot_buy_req", 0))   # ì´ë§¤ìˆ˜ì”ëŸ‰
            )
        else:
            print(f"âŒ í‚¤ì›€ ìš”ì²­ ì‹¤íŒ¨ {shcode}: {res.status_code}")
    except Exception as e:
        print(f"âŒ í‚¤ì›€ ì˜ˆì™¸ {shcode}: {e}")
    return (0, 0)

# âœ… MySQLì— ì €ì¥
def save_snapshot(data1102, data3320, hname):
    try:
        listed_shares = safe_int(data3320.get('gstock'))
        if listed_shares == 0:
            listed_shares = get_fallback_listed_shares(data1102.get('shcode'))

        # í‚¤ì›€ì—ì„œ ì´ ë§¤ë„/ë§¤ìˆ˜ì”ëŸ‰ ì¡°íšŒ
        shcode = data1102.get('shcode')
        total_offer, total_bid = get_total_qty_from_kiwoom(shcode)

        with pymysql.connect(**MYSQL_CONFIG) as conn:
            with conn.cursor() as cur:
                sql = """
                INSERT INTO stock_snapshot (
                    shcode, hname, price, change_pct, amount,
                    listed_shares, total_offer_qty, total_bid_qty, created_at
                ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)
                """
                cur.execute(sql, (
                    shcode,
                    hname,
                    safe_int(data1102.get('price')),
                    float(data1102.get('diff', 0)),
                    safe_int(data1102.get('value')),
                    listed_shares,
                    total_offer,
                    total_bid,
                    datetime.now()
                ))
            conn.commit()
        print(f"âœ… ì €ì¥ ì™„ë£Œ: {hname}")
    except Exception as e:
        print(f"âŒ ì €ì¥ ì‹¤íŒ¨ ({data1102.get('shcode')}): {e}")

# ì¢…ëª© 1ê°œ ì²˜ë¦¬
async def fetch_one(api, stock):
    shcode = stock['shcode']
    hname = stock['hname']

    try:
        res1102 = await api.request('t1102', {'t1102InBlock': {'shcode': shcode}})
        await asyncio.sleep(1)
        res3320 = await api.request('t3320', {'t3320InBlock': {'gicode': 'A' + shcode}})
        await asyncio.sleep(1)

        if res1102 and res3320:
            data1102 = res1102.body.get('t1102OutBlock', {})
            data3320 = res3320.body.get('t3320OutBlock', {})
            save_snapshot(data1102, data3320, hname)
        else:
            print(f"âŒ TR ì‹¤íŒ¨: {shcode}")
    except Exception as e:
        print(f"âŒ ì˜ˆì™¸ ë°œìƒ ({shcode}): {e}")

# ì „ì²´ ì¢…ëª© ë°˜ë³µ ì²˜ë¦¬
async def fetch_all():
    api = OpenApi()
    await api.login(appkey, appsecretkey)

    res = await api.request('t8436', {'t8436InBlock': {'gubun': '1'}})
    if not res:
        print("âŒ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ìš”ì²­ ì‹¤íŒ¨")
        return

    stock_list = res.body['t8436OutBlock']
    for stock in stock_list:
        await fetch_one(api, stock)

    await api.close()
    print("âœ… ì „ì²´ ì €ì¥ ì™„ë£Œ")

if __name__ == '__main__':
    asyncio.run(fetch_all())
